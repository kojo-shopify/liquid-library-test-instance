version: 2
jobs:
  build:
    docker:
      - image: circleci/node
    steps:
      - checkout
      - run:
          name: Global install ll-compiler
          command: 'yarn global add https://github.com/kojo-shopify/liquid-library-test-compiler'
      - run:
          name: Update $PATH to include yarn
          command: |
            echo 'export PATH=$HOME/.yarn/bin:$PATH' >> $BASH_ENV
            source /home/circleci/.bashrc
      - run:
          name: Build component README.md
          command: 'll_build_cat'
      - run:
          name: Build landing page README.md
          command: 'll_build_main'
      - run:
          name: BRANCH
          command: |
            if [ '0' >= 'git diff --numstat | wc -l' ]; then
              echo $CIRCLE_USER
            else
              echo $CIRCLE_USER
            fi
      - save_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/liquid-library-test-compiler
      - deploy:
          name: Deploy to Github
          command: |
            if [ $CIRCLE_BRANCH = "master" ]; then
                git config --global user.email "kojo.odapagyan@shopify.com"
                git config --global user.name "Kojo [CIRCLECI]"
                git add .
                git commit -m "CIRCLECI: project README files updated"
                git push origin master || { echo 'Updates unnecessary' ; exit 1; }
            else
              echo "Not master: tests passed"
            fi
