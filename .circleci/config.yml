version: 2
jobs:
  build:
    docker:
      - image: circleci/node
    steps:
      - checkout
      - run:
          name: Global install ll-compiler
          command: 'yarn global add https://github.com/kojo-shopify/liquid-library-test-compiler'
      - run:
          name: Update $PATH to include yarn
          command: |
            echo 'export PATH=$HOME/.yarn/bin:$PATH' >> $BASH_ENV
            source /home/circleci/.bashrc
      - run:
          name: Build component README.md
          command: 'll_build_cat'
      - run:
          name: Build landing page README.md
          command: 'll_build_main'
      - save_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/liquid-library-test-compiler
      - deploy:
          name: Deploy to Github
          command: |
            if [ "${CIRCLE_BRANCH}" = "master" ]; then
              go get github.com/tcnksm/ghr
              ghr -t ${ll_repo} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete 1.0./
            else
              echo "Not master: tests passed"
            fi
